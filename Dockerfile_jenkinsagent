FROM rahusona/jnlp-slave:4.13.3-1-alpine-jdk11

ENV TERRAFORM_VERSION=1.3.6

USER root

# Update Alpine Linux packages and install necessary packages
RUN apk update && \
    apk upgrade && \
    apk add --no-cache \
        curl \
        ca-certificates \
        openssl \
        libcurl

# Install AWS IAM Authenticator
RUN curl -o /usr/bin/aws-iam-authenticator https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator \
    && chmod +x /usr/bin/aws-iam-authenticator

# Upgrade pip and install yq
RUN pip install --upgrade pip setuptools \
    && pip install yq

# Install Docker
RUN curl -fsSL https://get.docker.com -o get-docker.sh \
    && sh get-docker.sh

# Add jenkins user to sudo and docker groups, set password
RUN usermod -a -G sudo jenkins \
    && usermod -a -G docker jenkins \
    && echo 'ALL ALL = (ALL) NOPASSWD: ALL' >> /etc/sudoers \
    && echo 'jenkins:secret' | chpasswd

# Install kubectl
RUN curl -o /usr/local/bin/kubectl https://storage.googleapis.com/kubernetes-release/release/v1.26.0/bin/linux/amd64/kubectl \
    && chmod +x /usr/local/bin/kubectl

# Install Helm
RUN curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 \
    && chmod +x get_helm.sh \
    && ./get_helm.sh

# Install Terraform
RUN wget https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip \
    && unzip terraform_${TERRAFORM_VERSION}_linux_amd64.zip -d /usr/local/bin \
    && rm terraform_${TERRAFORM_VERSION}_linux_amd64.zip

# Install OpenJDK
RUN wget -O - https://download.java.net/openjdk/jdk17/ri/openjdk-17+35_linux-x64_bin.tar.gz | tar -xz -C /opt/

# Install Maven
RUN wget -O - https://dlcdn.apache.org/maven/maven-3/3.8.8/binaries/apache-maven-3.8.8-bin.tar.gz | tar -xz -C /opt/

# Copy run.sh script
COPY run.sh /etc/run.sh

# Set entry point
ENTRYPOINT ["/etc/run.sh"]
